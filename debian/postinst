#!/bin/sh
# postinst script for igestis-ad
#
# see: dh_installdeb(1)

module=igestis-roundcube
CACHE_FOLDER="/var/cache/igestis/"


if [ -e /etc/igestis/debian-db.php ] ; then

    # Get database information
    dbname=$(cat /etc/igestis/debian-db.php  | grep "\$dbname" | cut -d\' -f2)
    dbuser=$(cat /etc/igestis/debian-db.php  | grep "\$dbuser" | cut -d\' -f2)
    dbpass=$(cat /etc/igestis/debian-db.php  | grep "\$dbpass" | cut -d\' -f2)

    # On vérifie que la structure de mise à jour automatique est bien présente.
    mysql -u$dbuser -p$dbpass $dbname \
	  -e 'CREATE TABLE IF NOT EXISTS `MYSQL_UPDATES` (
         	`sql_file` varchar(50) collate utf8_unicode_ci NOT NULL,
         	`date` datetime NOT NULL)
          ENGINE=MyISAM DEFAULT CHARSET=utf8
		  COLLATE=utf8_unicode_ci;'

    # On récupère et lance la liste des mises à jour.

    ls -v1 /usr/share/dbconfig-common/data/$module/install/ | while read i ; do
        file=$(mysql -u$dbuser -p$dbpass $dbname \
		  -e "SELECT sql_file FROM MYSQL_UPDATES WHERE sql_file='$module-$i';")

        if [ -z "$file" ] ; then
            mysql -u$dbuser -p$dbpass $dbname < /usr/share/dbconfig-common/data/$module/install/$i || true
            mysql -u$dbuser -p$dbpass $dbname \
			  -e "INSERT INTO MYSQL_UPDATES (sql_file, \`date\`) VALUES ('$module-$i', NOW());" 2> /dev/null
        fi
    done

    ls -v1 /usr/share/dbconfig-common/data/$module/upgrade/mysql/ | while read i ; do
        file=$(mysql -u$dbuser -p$dbpass $dbname \
		  -e "SELECT sql_file FROM MYSQL_UPDATES WHERE sql_file='$module-$i';")

        if [ -z "$file" ] ; then
            mysql -u$dbuser -p$dbpass $dbname < /usr/share/dbconfig-common/data/$module/upgrade/mysql/$i || true
            mysql -u$dbuser -p$dbpass $dbname \
			  -e "INSERT INTO MYSQL_UPDATES (sql_file, \`date\`) VALUES ('$module-$i', NOW());" 2> /dev/null
        fi
    done

fi


#postconf -e 'message_size_limit = 30000000'
#/etc/init.d/postfix reload

## We setup the cache folder to the right location
mkdir -p $CACHE_FOLDER
if [ ! -z "$CACHE_FOLDER" ] ; then rm -rf $CACHE_FOLDER/* ; fi

## We regenerate the language cache
php /usr/share/doc/igestis/regenLocales.php /usr/share/igestis
php /usr/share/igestis/command.php databases:update
chown www-data -R $CACHE_FOLDER
chmod 700 -R $CACHE_FOLDER

rm -rf /usr/share/igestis/install

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


